<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>{{ page.title }} | {{ site.title }}</title>
<link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e90ff">
</head>
<body>

<!-- Hamburger menu button -->
<button id="menu-toggle">â˜°</button>

<!-- Left sidebar -->
<nav class="sidebar-left">
  <h3>Pages</h3>
  <ul>
    {% assign sorted_pages = site.pages | sort: "nav_order" %}
    {% for p in sorted_pages %}
      {% if p.title %}
        <li><a href="{{ p.url | relative_url }}">{{ p.title }}</a></li>
        {% if forloop.index == 2 %}
          <hr>
        {% endif %}
      {% endif %}
    {% endfor %}
  </ul>
</nav>

<!-- Main content -->
<main>
  {{ content }}

  <!-- Commenti con CommentBox.io -->
  <section id="comments">
    <h3>Commenti</h3>
    <div class="commentbox"></div>
  </section>

  <script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script>
  <script>
    commentBox('5635888088350720-proj');
  </script>
</main>

<!-- Right sidebar Table of Contents (desktop only) -->
<aside class="sidebar-right">
  <h3>Contents</h3>
  <ul id="toc"></ul>
</aside>

<!-- Theme toggle -->
<button id="theme-toggle">Switch Theme</button>

<script>
// Hamburger menu toggle
document.getElementById("menu-toggle").addEventListener("click", () => {
  document.querySelector("nav.sidebar-left").classList.toggle("open");
});

// Theme toggle persistent
const themeToggle = document.getElementById("theme-toggle");

// Apply saved theme
if(localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  themeToggle.textContent = "Switch to Light Mode";
} else {
  themeToggle.textContent = "Switch to Dark Mode";
}

// Toggle theme and save
themeToggle.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  if(document.body.classList.contains("dark")) {
    localStorage.setItem("theme","dark");
    themeToggle.textContent = "Switch to Light Mode";
  } else {
    localStorage.setItem("theme","light");
    themeToggle.textContent = "Switch to Dark Mode";
  }
});

// Generate Desktop TOC (h2/h3)
const toc = document.getElementById("toc");
const headings = document.querySelectorAll('main h2, main h3');
headings.forEach(heading => {
  const id = heading.id || heading.textContent.toLowerCase().replace(/\s+/g,'-').replace(/[^\w-]/g,'');
  heading.id = id;
  const a = document.createElement('a');
  a.href = `#${id}`;
  a.textContent = heading.textContent;
  a.className = heading.tagName.toLowerCase();
  toc.appendChild(a);
});

// Scrollspy: highlight active heading
window.addEventListener('scroll', () => {
  let current = headings[0];
  headings.forEach(h => { if(window.scrollY >= h.offsetTop - 20) current = h; });
  document.querySelectorAll('.sidebar-right a').forEach(a => a.classList.remove('active'));
  const activeLink = document.querySelector(`.sidebar-right a[href="#${current.id}"]`);
  if(activeLink) activeLink.classList.add('active');
});

// Generate Mobile TOC
document.addEventListener("DOMContentLoaded", () => {
  const mobileTOC = document.querySelector(".mobile-toc ul");
  if (!mobileTOC) return;

  headings.forEach(heading => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = `#${heading.id}`;
    a.textContent = heading.textContent;
    li.appendChild(a);
    if (heading.tagName.toLowerCase() === "h3") li.style.marginLeft = "1.2em";
    mobileTOC.appendChild(li);
  });
});
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(
      function(registration) {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, function(err) {
        console.log('ServiceWorker registration failed: ', err);
      }
    );
  });
}
</script>

</body>
</html>
